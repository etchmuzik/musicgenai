<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicGen AI Studio - Professional Music Creation</title>
    <meta name="description" content="Professional music creation studio with AI generation, advanced audio editing, and real-time effects.">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/audioEditor.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0c0c0f;
            --bg-secondary: #1a1a1f;
            --bg-card: rgba(42, 42, 58, 0.4);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: #b4b4c7;
            --text-muted: #71717a;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --accent-light: #a78bfa;
            --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #ec4899 50%, #f97316 100%);
            --glass-gradient: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(139, 92, 246, 0.3);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 16px 0;
            background: rgba(12, 12, 15, 0.8);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 700;
            background: var(--purple-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: color 0.3s ease;
        }
        
        .nav-links a:hover {
            color: var(--text-primary);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        
        .credits-display {
            background: var(--bg-glass);
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            color: var(--accent-light);
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        /* Studio Layout */
        .studio-container {
            margin-top: 70px;
            height: calc(100vh - 70px);
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 0;
        }
        
        /* Generation Panel */
        .generation-panel {
            grid-column: 1;
            grid-row: 1 / 3;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .generation-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .advanced-controls {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .range-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .range-control input[type="range"] {
            width: 100%;
        }
        
        .range-value {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .generate-button {
            padding: 14px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
            width: 100%;
        }
        
        .generate-button:hover:not(:disabled) {
            background: var(--accent-hover);
        }
        
        .generate-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Queue Status */
        .queue-status {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .queue-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }
        
        .queue-item:last-child {
            border-bottom: none;
        }
        
        .queue-progress {
            width: 60px;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .queue-progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        
        /* Main Editor Area */
        .editor-area {
            grid-column: 2;
            grid-row: 1 / 3;
            background: var(--bg-primary);
            overflow: hidden;
            position: relative;
        }
        
        .editor-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        .editor-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .editor-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent);
        }
        
        .editor-tab:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }
        
        .editor-content {
            height: calc(100% - 49px);
            overflow: hidden;
        }
        
        .tab-pane {
            display: none;
            height: 100%;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Library Panel */
        .library-panel {
            padding: 20px;
            overflow-y: auto;
        }
        
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .library-item {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .library-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .library-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .library-item-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .library-item-controls {
            display: flex;
            gap: 8px;
        }
        
        .library-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .library-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        /* Status Bar */
        .status-bar {
            grid-column: 1 / 3;
            grid-row: 3;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Alerts */
        .alert {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 2000;
            transform: translateX(300px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }
        
        .alert.show {
            transform: translateX(0);
        }
        
        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Suno-style Controls */
        .suno-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .suno-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--purple-gradient);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
        }
        
        .suno-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.6);
        }
        
        .suno-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--purple-gradient);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
        }
        
        .suno-select {
            background: var(--bg-primary) !important;
            border: 1px solid var(--border) !important;
            border-radius: 8px !important;
            color: var(--text-primary) !important;
            padding: 8px 12px !important;
            margin-top: 4px;
        }
        
        .range-control {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .range-control label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }
        
        .range-value {
            text-align: center;
            font-size: 11px;
            color: var(--accent-light);
            font-weight: 600;
            margin-top: 8px;
        }
        
        .suno-input {
            background: var(--bg-primary) !important;
            border: 1px solid var(--border) !important;
            border-radius: 8px !important;
            color: var(--text-primary) !important;
            padding: 12px 16px !important;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .suno-input:focus {
            border-color: var(--accent) !important;
            outline: none;
        }
        
        .exclude-styles-section {
            margin-bottom: 16px;
        }
        
        .exclude-styles-section label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }
        
        .exclude-input {
            width: 100%;
            font-size: 13px;
        }
        
        .new-badge {
            background: var(--purple-gradient);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 700;
            margin-left: 8px;
        }
        
        .more-options {
            margin-top: 16px;
            border-top: 1px solid var(--border);
            padding-top: 16px;
        }
        
        .more-options-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }
        
        .more-options-toggle:hover {
            color: var(--text-primary);
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .more-options-toggle.active .toggle-icon {
            transform: rotate(180deg);
        }
        
        .more-options-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding-top: 0;
        }
        
        .more-options-content.active {
            max-height: 200px;
            padding-top: 16px;
        }
        
        .more-options-content .form-group {
            margin-bottom: 16px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .studio-container {
                grid-template-columns: 300px 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .studio-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
            
            .generation-panel {
                grid-column: 1;
                grid-row: 2;
                max-height: 300px;
            }
            
            .editor-area {
                grid-column: 1;
                grid-row: 3;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">🎵 MusicGen AI Studio</div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/app.html">Simple Studio</a>
                <div class="user-info">
                    <div class="credits-display" id="creditsDisplay">∞ Credits</div>
                    <span id="userName">Studio Mode</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Studio Layout -->
    <div class="studio-container">
        <!-- Generation Panel -->
        <div class="generation-panel">
            <h2 class="panel-title">🎵 AI Music Generation</h2>
            
            <form class="generation-form" id="generationForm">
                <div class="form-group">
                    <label for="prompt">Describe your music</label>
                    <textarea 
                        id="prompt" 
                        placeholder="e.g., Epic cinematic orchestral piece with soaring violins and thunderous drums, building to a powerful climax"
                        required
                    ></textarea>
                </div>
                
                <div class="form-group">
                    <label for="genre">Genre</label>
                    <select id="genre">
                        <option value="">Auto-detect</option>
                        <option value="house">House</option>
                        <option value="techno">Techno</option>
                        <option value="electronic">Electronic</option>
                        <option value="edm">EDM</option>
                        <option value="trance">Trance</option>
                        <option value="dubstep">Dubstep</option>
                        <option value="drum-and-bass">Drum & Bass</option>
                        <option value="ambient">Ambient</option>
                        <option value="chill">Chill</option>
                        <option value="lo-fi">Lo-Fi</option>
                        <option value="synthwave">Synthwave</option>
                        <option value="pop">Pop</option>
                        <option value="rock">Rock</option>
                        <option value="indie">Indie</option>
                        <option value="hip-hop">Hip Hop</option>
                        <option value="trap">Trap</option>
                        <option value="jazz">Jazz</option>
                        <option value="blues">Blues</option>
                        <option value="funk">Funk</option>
                        <option value="reggae">Reggae</option>
                        <option value="latin">Latin</option>
                        <option value="afrobeat">Afrobeat</option>
                        <option value="classical">Classical</option>
                        <option value="cinematic">Cinematic</option>
                        <option value="orchestral">Orchestral</option>
                        <option value="world">World</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="duration">Duration</label>
                    <select id="duration">
                        <option value="30">30 seconds</option>
                        <option value="60" selected>1 minute</option>
                        <option value="120">2 minutes</option>
                        <option value="180">3 minutes</option>
                        <option value="240">4 minutes</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="songTitle">Song Title</label>
                    <input type="text" id="songTitle" placeholder="Enter song title" class="suno-input">
                </div>
                
                <div class="advanced-controls">
                    <h4 style="margin-bottom: 12px; font-size: 14px;">Advanced Options <span class="new-badge">NEW</span></h4>
                    
                    <div class="exclude-styles-section">
                        <label>Exclude styles</label>
                        <input type="text" id="excludeStyles" placeholder="e.g., metal, screaming, distorted" class="suno-input exclude-input">
                    </div>
                    
                    <div class="control-grid">
                        <div class="range-control">
                            <label>Weirdness</label>
                            <input type="range" id="energy" min="0" max="1" value="0.5" step="0.1" class="suno-slider">
                            <div class="range-value">50%</div>
                        </div>
                        
                        <div class="range-control">
                            <label>Style Influence</label>
                            <input type="range" id="creativity" min="0" max="1" value="0.5" step="0.1" class="suno-slider">
                            <div class="range-value">50%</div>
                        </div>
                        
                        <div class="range-control">
                            <label>BPM</label>
                            <input type="range" id="bpm" min="60" max="180" value="120" step="5" class="suno-slider">
                            <div class="range-value">120</div>
                        </div>
                        
                        <div class="range-control">
                            <label>Quality</label>
                            <select id="quality" class="suno-select">
                                <option value="standard">Standard</option>
                                <option value="high" selected>High</option>
                                <option value="ultra">Ultra</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="more-options">
                        <button type="button" class="more-options-toggle" onclick="toggleMoreOptions()">
                            More Options <span class="toggle-icon">▼</span>
                        </button>
                        <div class="more-options-content" id="moreOptionsContent">
                            <div class="form-group">
                                <label for="instrumentalMode">Mode</label>
                                <select id="instrumentalMode" class="suno-select">
                                    <option value="true" selected>Instrumental</option>
                                    <option value="false">With Vocals</option>
                                    <option value="mixed">Mixed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="musicKey">Key</label>
                                <select id="musicKey" class="suno-select">
                                    <option value="">Auto</option>
                                    <option value="C">C Major</option>
                                    <option value="D">D Major</option>
                                    <option value="E">E Major</option>
                                    <option value="F">F Major</option>
                                    <option value="G">G Major</option>
                                    <option value="A">A Major</option>
                                    <option value="B">B Major</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="generate-button" id="generateButton">
                    ✨ Generate Music
                </button>
            </form>
            
            <!-- Generation Queue -->
            <div class="queue-status" id="queueStatus">
                <div class="queue-title">Generation Queue</div>
                <div id="queueList">
                    <div style="text-align: center; color: var(--text-muted); font-size: 12px;">
                        No active generations
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Editor Area -->
        <div class="editor-area">
            <div class="editor-tabs">
                <button class="editor-tab active" data-tab="editor">🎛️ Audio Editor</button>
                <button class="editor-tab" data-tab="library">📚 Library</button>
                <button class="editor-tab" data-tab="mixer">🎚️ Mixer</button>
            </div>
            
            <div class="editor-content">
                <!-- Audio Editor Tab -->
                <div class="tab-pane active" id="editorTab">
                    <div id="audioEditorContainer">
                        <!-- Audio editor will be initialized here -->
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">🎵</div>
                                <h3>Generate or load a track to start editing</h3>
                                <p style="margin-top: 8px;">Professional audio editing with real-time effects</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Library Tab -->
                <div class="tab-pane" id="libraryTab">
                    <div class="library-panel">
                        <div class="library-grid" id="libraryGrid">
                            <!-- Library items will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Mixer Tab -->
                <div class="tab-pane" id="mixerTab">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 16px;">🎚️</div>
                            <h3>Advanced Mixer</h3>
                            <p style="margin-top: 8px;">Coming soon - Multi-track mixing and mastering</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <span id="statusInfo">Ready</span>
            <span id="apiStatus">API: Connected</span>
            <span id="systemInfo">Studio Mode</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/musicGeneration.js"></script>
    <script src="js/audioEditor.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase (same as app.html)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD-j-pmBhdIMHqsgFrcbVJulXON9yKv9VU",
            authDomain: "musicgen-6cea1.firebaseapp.com",
            projectId: "musicgen-6cea1",
            storageBucket: "musicgen-6cea1.firebasestorage.app",
            messagingSenderId: "392958246299",
            appId: "1:392958246299:web:your-web-app-id"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Initialize services
        let musicService = null;
        let audioEditor = null;
        let currentUser = null;

        // Initialize music service
        if (window.MusicGenerationService) {
            musicService = new MusicGenerationService();
            musicService.setApiKey('d3a513bec58ea7c7e60eebf377fbbfb806f2304f12e1ef208cd701139658c088');
            console.log('🎵 Music generation service initialized');
        } else {
            console.error('🚨 MusicGenerationService class not found');
        }

        // DOM elements
        const generationForm = document.getElementById('generationForm');
        const generateButton = document.getElementById('generateButton');
        const queueList = document.getElementById('queueList');
        const libraryGrid = document.getElementById('libraryGrid');
        const editorTabs = document.querySelectorAll('.editor-tab');
        const tabPanes = document.querySelectorAll('.tab-pane');

        // Initialize studio
        async function initializeStudio() {
            console.log('🎵 Initializing studio...');
            
            // Check if all required DOM elements exist
            checkDOMElements();
            
            // Initialize audio editor
            const editorContainer = document.getElementById('audioEditorContainer');
            if (editorContainer && window.AdvancedAudioEditor) {
                try {
                    audioEditor = new AdvancedAudioEditor(editorContainer);
                    console.log('🎧 Audio editor initialized');
                } catch (error) {
                    console.error('🚨 Failed to initialize audio editor:', error);
                }
            } else {
                console.warn('⚠️ Audio editor container or class not found');
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Load user library
            loadLibrary();
            
            console.log('🎵 Studio initialized successfully');
        }
        
        // Check if all DOM elements are available
        function checkDOMElements() {
            const requiredElements = [
                'generationForm', 'generateButton', 'prompt', 'genre', 
                'duration', 'energy', 'creativity', 'bpm', 'quality'
            ];
            
            const missingElements = [];
            requiredElements.forEach(id => {
                if (!document.getElementById(id)) {
                    missingElements.push(id);
                }
            });
            
            if (missingElements.length > 0) {
                console.error('🚨 Missing DOM elements:', missingElements);
            } else {
                console.log('✅ All required DOM elements found');
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Generation form
            if (generationForm) {
                generationForm.addEventListener('submit', handleGeneration);
            }
            
            // Tab switching
            editorTabs.forEach(tab => {
                tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });
            
            // Range controls
            const energySlider = document.getElementById('energy');
            const creativitySlider = document.getElementById('creativity');
            const bpmSlider = document.getElementById('bpm');
            
            if (energySlider) {
                energySlider.addEventListener('input', (e) => {
                    const valueDisplay = e.target.parentElement.querySelector('.range-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = Math.round(e.target.value * 100) + '%';
                    }
                });
            }
            
            if (creativitySlider) {
                creativitySlider.addEventListener('input', (e) => {
                    const valueDisplay = e.target.parentElement.querySelector('.range-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = Math.round(e.target.value * 100) + '%';
                    }
                });
            }
            
            if (bpmSlider) {
                bpmSlider.addEventListener('input', (e) => {
                    const valueDisplay = e.target.parentElement.querySelector('.range-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = e.target.value;
                    }
                });
            }
            
            // Queue updates
            if (musicService) {
                musicService.addEventListener('queueUpdated', updateQueueDisplay);
            }
            
            // Test button functionality
            if (generateButton) {
                console.log('✅ Generate button found and ready');
            }
            
            // Add click handler for testing
            if (generateButton) {
                generateButton.addEventListener('click', (e) => {
                    console.log('🎵 Generate button clicked');
                });
            }
        }

        // Handle music generation
        async function handleGeneration(e) {
            e.preventDefault();
            console.log('🎵 Generation form submitted');
            
            // Get form values with proper error handling
            const promptValue = document.getElementById('prompt')?.value;
            if (!promptValue || promptValue.trim().length === 0) {
                showAlert('Please enter a music description', 'error');
                return;
            }
            
            const params = {
                prompt: promptValue.trim(),
                genre: document.getElementById('genre')?.value || '',
                duration: parseInt(document.getElementById('duration')?.value || '60'),
                energy: parseFloat(document.getElementById('energy')?.value || '0.5'),
                creativity: parseFloat(document.getElementById('creativity')?.value || '0.5'),
                bpm: parseInt(document.getElementById('bpm')?.value || '120'),
                quality: document.getElementById('quality')?.value || 'high',
                title: document.getElementById('songTitle')?.value || '',
                excludeStyles: document.getElementById('excludeStyles')?.value || '',
                instrumental: document.getElementById('instrumentalMode')?.value !== 'false',
                key: document.getElementById('musicKey')?.value || ''
            };
            
            console.log('🎵 Generation parameters:', params);

            // Check if music service is available
            if (!musicService) {
                showAlert('Music generation service not available', 'error');
                return;
            }

            // Validate parameters
            const errors = musicService.validateParams(params);
            if (errors.length > 0) {
                showAlert(errors[0], 'error');
                return;
            }

            generateButton.disabled = true;
            generateButton.innerHTML = '<span class="loading"></span> Generating...';

            try {
                console.log('🎵 Starting music generation...');
                const generationId = await musicService.generateMusic(
                    params,
                    (progress, message) => {
                        // Progress callback
                        console.log(`🎵 Progress: ${progress}% - ${message}`);
                        updateGenerationProgress(generationId, progress, message);
                    },
                    (track) => {
                        // Success callback
                        console.log('🎵 Generation completed:', track);
                        onGenerationComplete(track);
                    },
                    (error) => {
                        // Error callback
                        console.error('🎵 Generation error:', error);
                        showAlert('Generation failed: ' + error.message, 'error');
                    }
                );

                console.log('🎵 Generation ID:', generationId);
                showAlert('Generation started successfully!', 'success');
                
            } catch (error) {
                console.error('🎵 Failed to start generation:', error);
                showAlert('Failed to start generation: ' + error.message, 'error');
            } finally {
                generateButton.disabled = false;
                generateButton.innerHTML = '✨ Generate Music';
            }
        }

        // Update generation progress
        function updateGenerationProgress(id, progress, message) {
            const progressBar = document.querySelector(`[data-generation-id="${id}"] .queue-progress-fill`);
            const statusText = document.querySelector(`[data-generation-id="${id}"] .queue-status`);
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            if (statusText) {
                statusText.textContent = message;
            }
        }

        // Handle generation completion
        async function onGenerationComplete(track) {
            showAlert('Music generated successfully!', 'success');
            
            // Add to library
            addToLibrary(track);
            
            // Load into editor if no track is currently loaded
            if (!audioEditor.audioBuffer) {
                await loadTrackIntoEditor(track);
                switchTab('editor');
            }
        }

        // Load track into audio editor
        async function loadTrackIntoEditor(track) {
            try {
                // Fetch audio data
                const response = await fetch(track.localURL || track.audioURL);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioEditor.audioContext.decodeAudioData(arrayBuffer);
                
                // Load into editor
                await audioEditor.loadAudio(audioBuffer);
                
                showAlert('Track loaded into editor', 'success');
                
            } catch (error) {
                console.error('Failed to load track into editor:', error);
                showAlert('Failed to load track into editor', 'error');
            }
        }

        // Add track to library
        function addToLibrary(track) {
            const libraryItem = document.createElement('div');
            libraryItem.className = 'library-item';
            libraryItem.innerHTML = `
                <div class="library-item-title">${track.title}</div>
                <div class="library-item-info">${track.genre} • ${track.duration}s</div>
                <div class="library-item-controls">
                    <button class="library-btn" onclick="playTrackPreview('${track.audioURL}')">▶️</button>
                    <button class="library-btn" onclick="loadTrackIntoEditor(${JSON.stringify(track).replace(/"/g, '&quot;')})">Edit</button>
                    <button class="library-btn" onclick="downloadTrack('${track.audioURL}', '${track.title}')">⬇️</button>
                </div>
            `;
            
            libraryGrid.insertBefore(libraryItem, libraryGrid.firstChild);
        }

        // Switch tabs
        function switchTab(tabName) {
            editorTabs.forEach(tab => tab.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // Update queue display
        function updateQueueDisplay(queueStatus) {
            if (queueStatus.total === 0) {
                queueList.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-size: 12px;">No active generations</div>';
                return;
            }
            
            // Update queue display with current generations
            // This would show active and queued generations
        }

        // Load user library
        function loadLibrary() {
            // Load saved tracks from Firestore
            // For now, show placeholder
            libraryGrid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 40px;">
                    <div style="font-size: 32px; margin-bottom: 16px;">🎵</div>
                    <h3>Your music library is empty</h3>
                    <p style="margin-top: 8px;">Generate your first track to get started!</p>
                </div>
            `;
        }

        // Alert system
        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.classList.add('show'), 100);
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // Global functions for library interactions
        window.playTrackPreview = function(audioURL) {
            // Implement audio preview
            const audio = new Audio(audioURL);
            audio.play();
        };

        window.loadTrackIntoEditor = loadTrackIntoEditor;

        window.downloadTrack = function(audioURL, title) {
            const a = document.createElement('a');
            a.href = audioURL;
            a.download = `${title}.mp3`;
            a.click();
        };

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('userName').textContent = user.displayName || user.email;
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeStudio);
        
        // Global function for More Options toggle
        window.toggleMoreOptions = function() {
            const toggle = document.querySelector('.more-options-toggle');
            const content = document.getElementById('moreOptionsContent');
            
            if (toggle && content) {
                toggle.classList.toggle('active');
                content.classList.toggle('active');
            }
        };
        
        // Test function for debugging
        window.testGeneration = function() {
            console.log('🧪 Testing music generation...');
            
            // Fill in test values
            document.getElementById('prompt').value = 'Upbeat electronic dance music with heavy bass';
            document.getElementById('genre').value = 'electronic';
            document.getElementById('duration').value = '60';
            
            // Trigger form submission
            const form = document.getElementById('generationForm');
            if (form) {
                const event = new Event('submit', { bubbles: true, cancelable: true });
                form.dispatchEvent(event);
            }
        };
        
        // Debug function to check all elements
        window.debugStudio = function() {
            console.log('🔍 Studio Debug Info:');
            console.log('Music Service:', !!musicService);
            console.log('Audio Editor:', !!audioEditor);
            console.log('Generation Form:', !!document.getElementById('generationForm'));
            console.log('Generate Button:', !!document.getElementById('generateButton'));
            console.log('Prompt Field:', !!document.getElementById('prompt'));
            console.log('All sliders working:', {
                energy: !!document.getElementById('energy'),
                creativity: !!document.getElementById('creativity'),
                bpm: !!document.getElementById('bpm')
            });
        };
    </script>
</body>
</html>