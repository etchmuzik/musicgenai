<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Music - MusicGen AI</title>
    <meta name="description" content="Create amazing AI-generated music with simple prompts or custom lyrics">
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Suno Design System -->
    <link rel="stylesheet" href="/css/suno-design.css">
    
    <style>
        /* Create page specific styles */
        .create-section {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .create-header {
            margin-bottom: 2rem;
        }

        .create-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .create-subtitle {
            color: var(--text-secondary);
        }

        .creation-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-card:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }

        .mode-card.active {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.15);
        }

        .mode-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .mode-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .mode-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .generation-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .style-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .style-pill {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .style-pill:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .style-pill.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .generation-progress {
            display: none;
            text-align: center;
            padding: 3rem 2rem;
        }

        .generation-progress.active {
            display: block;
        }

        .progress-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 2rem;
            animation: spin 1s linear infinite;
        }

        .progress-text {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .progress-subtext {
            color: var(--text-secondary);
        }

        .generation-result {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .generation-result.active {
            display: block;
        }

        .result-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 1rem;
        }

        .result-player {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .result-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .creation-modes {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <a href="/" class="logo">MusicGen AI</a>
        
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/" class="nav-link">
                        <span class="nav-icon"><i class="fas fa-home"></i></span>
                        Home
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/create" class="nav-link active">
                        <span class="nav-icon"><i class="fas fa-music"></i></span>
                        Create
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/library" class="nav-link">
                        <span class="nav-icon"><i class="fas fa-folder"></i></span>
                        Library
                    </a>
                </li>
            </ul>
        </nav>
        
        <!-- Credits Display -->
        <div class="credits-display">
            <div class="credits-header">
                <span class="credits-title">Credits</span>
                <i class="fas fa-coins"></i>
            </div>
            <div class="credits-value" id="userCredits">200</div>
            <div class="credits-subtitle">Monthly credits remaining</div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem; justify-content: center;" onclick="alert('Pricing page coming soon!')">
                Upgrade Plan
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <h1 class="header-title">
                Create Your <span class="gradient-text">Masterpiece</span>
            </h1>
            <p class="header-subtitle">
                Choose your creation mode and let AI transform your ideas into music
            </p>
        </header>

        <!-- Creation Modes -->
        <section class="create-section">
            <div class="create-header">
                <h2 class="create-title">Choose Creation Mode</h2>
                <p class="create-subtitle">Select how you want to create your music</p>
            </div>

            <div class="creation-modes">
                <div class="mode-card active" data-mode="simple">
                    <div class="mode-icon">üéµ</div>
                    <h3 class="mode-title">Simple Creation</h3>
                    <p class="mode-description">Describe your song in words and let AI create it</p>
                </div>
                <div class="mode-card" data-mode="lyrics">
                    <div class="mode-icon">üìù</div>
                    <h3 class="mode-title">Custom Lyrics</h3>
                    <p class="mode-description">Provide your own lyrics and choose the style</p>
                </div>
                <div class="mode-card" data-mode="remix">
                    <div class="mode-icon">üîÑ</div>
                    <h3 class="mode-title">Remix & Extend</h3>
                    <p class="mode-description">Upload a track to remix or extend</p>
                </div>
            </div>
        </section>

        <!-- Generation Form -->
        <section class="create-section" id="generationSection">
            <div class="create-header">
                <h2 class="create-title">Song Details</h2>
                <p class="create-subtitle">Describe your vision and we'll make it reality</p>
            </div>

            <form class="generation-form" id="generationForm">
                <div class="form-group" id="descriptionGroup">
                    <label class="form-label">Song Description</label>
                    <textarea 
                        class="form-textarea" 
                        id="songDescription" 
                        placeholder="A happy pop song about summer vacation with upbeat melody and catchy chorus..."
                        rows="4"
                    ></textarea>
                </div>
                
                <div class="form-group" id="lyricsGroup" style="display: none;">
                    <label class="form-label">Custom Lyrics</label>
                    <textarea 
                        class="form-textarea" 
                        id="customLyrics" 
                        placeholder="Verse 1:&#10;Walking down the beach at sunset...&#10;&#10;Chorus:&#10;Summer dreams come alive..."
                        rows="8"
                    ></textarea>
                </div>
                
                <div class="form-group" id="uploadGroup" style="display: none;">
                    <label class="form-label">Upload Track to Remix/Extend</label>
                    <input type="file" accept="audio/*" id="audioUpload" class="form-input" />
                    <p class="form-hint">Upload an MP3 or WAV file to remix or extend</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <select class="form-select" id="duration">
                            <option value="30">30 seconds</option>
                            <option value="60" selected>1 minute</option>
                            <option value="120">2 minutes</option>
                            <option value="240">4 minutes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Music Type</label>
                        <select class="form-select" id="musicType">
                            <option value="instrumental">Instrumental</option>
                            <option value="vocal" selected>With Vocals</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Style & Genre (Optional)</label>
                    <div class="style-pills">
                        <div class="style-pill" data-style="pop">Pop</div>
                        <div class="style-pill" data-style="rock">Rock</div>
                        <div class="style-pill" data-style="electronic">Electronic</div>
                        <div class="style-pill" data-style="hiphop">Hip Hop</div>
                        <div class="style-pill" data-style="jazz">Jazz</div>
                        <div class="style-pill" data-style="classical">Classical</div>
                        <div class="style-pill" data-style="country">Country</div>
                        <div class="style-pill" data-style="rnb">R&B</div>
                        <div class="style-pill" data-style="folk">Folk</div>
                        <div class="style-pill" data-style="ambient">Ambient</div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="font-size: 1.125rem; padding: 1rem 2rem;">
                    <i class="fas fa-magic"></i>
                    Generate Music (5 Credits)
                </button>
            </form>
        </section>

        <!-- Generation Progress -->
        <section class="create-section generation-progress" id="generationProgress">
            <div class="progress-spinner"></div>
            <h3 class="progress-text">Creating your masterpiece...</h3>
            <p class="progress-subtext">This usually takes 30-60 seconds</p>
        </section>

        <!-- Generation Result -->
        <section class="create-section generation-result" id="generationResult">
            <div class="result-icon">üéâ</div>
            <h3 class="progress-text">Your song is ready!</h3>
            
            <div class="result-player">
                <audio controls style="width: 100%;" id="resultAudio">
                    <source src="" type="audio/mpeg">
                </audio>
                <h4 style="margin-top: 1rem;" id="resultTitle">Generated Song</h4>
            </div>

            <div class="result-actions">
                <button class="btn btn-secondary" onclick="downloadSong()">
                    <i class="fas fa-download"></i>
                    Download
                </button>
                <button class="btn btn-accent" onclick="addToLibrary()">
                    <i class="fas fa-plus"></i>
                    Add to Library
                </button>
                <button class="btn btn-primary" onclick="createAnother()">
                    <i class="fas fa-magic"></i>
                    Create Another
                </button>
            </div>
        </section>
    </main>

    <!-- Player Bar -->
    <div class="player-bar">
        <div class="player-track">
            <div class="player-cover" id="playerCover"></div>
            <div class="player-info">
                <div class="player-title" id="playerTitle">No track playing</div>
                <div class="player-artist" id="playerArtist">Select a track to play</div>
            </div>
        </div>
        
        <div class="player-controls">
            <button class="player-btn" id="prevBtn">
                <i class="fas fa-backward"></i>
            </button>
            <button class="player-btn play" id="playBtn">
                <i class="fas fa-play"></i>
            </button>
            <button class="player-btn" id="nextBtn">
                <i class="fas fa-forward"></i>
            </button>
        </div>
        
        <div class="player-progress">
            <span class="player-time" id="currentTime">0:00</span>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span class="player-time" id="totalTime">0:00</span>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/js/suno-core.js"></script>
    <script src="/js/piapi-music.js"></script>
    
    <script>
        // Initialize PiAPI
        const piapi = new PiAPIMusic(); // Uses the key from piapi-music.js
        // Creation mode selection
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                const mode = this.dataset.mode;
                updateFormForMode(mode);
            });
        });

        // Style pill selection
        document.querySelectorAll('.style-pill').forEach(pill => {
            pill.addEventListener('click', function() {
                this.classList.toggle('selected');
            });
        });

        // Form submission
        document.getElementById('generationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const description = document.getElementById('songDescription').value.trim();
            if (!description) {
                alert('Please describe what kind of song you want');
                return;
            }

            // Show progress
            document.getElementById('generationSection').style.display = 'none';
            document.getElementById('generationProgress').classList.add('active');

            try {
                // Call music generation API
                const result = await generateMusic({
                    prompt: description,
                    duration: document.getElementById('duration').value,
                    type: document.getElementById('musicType').value,
                    styles: getSelectedStyles()
                });

                // Simulate generation time
                setTimeout(() => {
                    showResult(result);
                }, 3000);

            } catch (error) {
                console.error('Generation failed:', error);
                alert('Generation failed. Please try again.');
                resetForm();
            }
        });

        function updateFormForMode(mode) {
            // Hide all mode-specific fields
            document.getElementById('descriptionGroup').style.display = 'none';
            document.getElementById('lyricsGroup').style.display = 'none';
            document.getElementById('uploadGroup').style.display = 'none';
            
            // Show relevant fields based on mode
            switch(mode) {
                case 'simple':
                    document.getElementById('descriptionGroup').style.display = 'block';
                    break;
                case 'lyrics':
                    document.getElementById('descriptionGroup').style.display = 'block';
                    document.getElementById('lyricsGroup').style.display = 'block';
                    break;
                case 'remix':
                    document.getElementById('uploadGroup').style.display = 'block';
                    document.getElementById('descriptionGroup').style.display = 'block';
                    break;
            }
        }

        function getSelectedStyles() {
            return Array.from(document.querySelectorAll('.style-pill.selected'))
                .map(pill => pill.dataset.style);
        }

        async function generateMusic(params) {
            try {
                // Get selected mode
                const mode = document.querySelector('.mode-card.active').dataset.mode;
                
                // Build style prompt from selected pills
                const stylePrompt = piapi.buildStylePrompt({
                    genre: params.styles[0],
                    mood: params.styles[1],
                    tempo: params.duration > 120 ? 'slow' : 'medium'
                });
                
                let result;
                
                if (mode === 'lyrics') {
                    // Generate with custom lyrics
                    const lyricsText = document.getElementById('customLyrics')?.value || params.prompt;
                    result = await piapi.createFromLyrics({
                        lyrics: lyricsText,
                        style: stylePrompt,
                        voice_type: params.type === 'vocal' ? 'auto' : 'instrumental'
                    });
                } else if (mode === 'remix') {
                    // For remix mode (would need file upload)
                    alert('Remix mode requires file upload - coming soon!');
                    return { success: false };
                } else {
                    // Simple creation mode
                    result = await piapi.createMusic({
                        prompt: params.prompt,
                        style: stylePrompt,
                        duration: parseInt(params.duration),
                        instrumental: params.type === 'instrumental',
                        model: 'suno-v3.5'
                    });
                }
                
                if (result.success) {
                    // Poll for completion
                    updateProgress('Generating your music...', 25);
                    
                    const finalResult = await pollForResult(result.taskId);
                    return finalResult;
                } else {
                    throw new Error(result.error || 'Generation failed');
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                throw error;
            }
        }
        
        async function pollForResult(taskId) {
            let attempts = 0;
            const maxAttempts = 60;
            
            while (attempts < maxAttempts) {
                const result = await piapi.getTask(taskId);
                
                if (result.status === 'completed' && result.output) {
                    return {
                        success: true,
                        audio_url: result.output.audio_url || result.output.url,
                        title: result.output.title || 'Generated Song',
                        duration: result.output.duration,
                        taskId: taskId
                    };
                } else if (result.status === 'failed') {
                    throw new Error(result.error || 'Generation failed');
                }
                
                // Update progress
                const progress = Math.min(25 + (attempts / maxAttempts) * 70, 95);
                updateProgress(`Processing... ${Math.round(progress)}%`, progress);
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                attempts++;
            }
            
            throw new Error('Generation timeout');
        }
        
        function updateProgress(text, percent) {
            const progressText = document.querySelector('.progress-text');
            const progressSubtext = document.querySelector('.progress-subtext');
            
            if (progressText) progressText.textContent = text;
            if (progressSubtext) progressSubtext.textContent = `${Math.round(percent)}% complete`;
        }

        function showResult(result) {
            document.getElementById('generationProgress').classList.remove('active');
            document.getElementById('generationResult').classList.add('active');
            
            // Update result display
            if (result.audio_url && result.audio_url !== '#') {
                document.getElementById('resultAudio').src = result.audio_url;
            }
            document.getElementById('resultTitle').textContent = result.title || 'Generated Song';
            
            // Store result for download/library
            window.currentGeneratedTrack = result;
        }

        function downloadSong() {
            if (window.currentGeneratedTrack && window.currentGeneratedTrack.audio_url) {
                const link = document.createElement('a');
                link.href = window.currentGeneratedTrack.audio_url;
                link.download = `${window.currentGeneratedTrack.title || 'generated-song'}.mp3`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('No track available to download');
            }
        }

        function addToLibrary() {
            if (window.currentGeneratedTrack) {
                // Get existing library or create new
                let library = JSON.parse(localStorage.getItem('musicLibrary') || '[]');
                
                // Add new track
                const track = {
                    id: window.currentGeneratedTrack.taskId || Date.now().toString(),
                    title: window.currentGeneratedTrack.title || 'Generated Song',
                    audio_url: window.currentGeneratedTrack.audio_url,
                    created_at: new Date().toISOString(),
                    duration: window.currentGeneratedTrack.duration,
                    genre: getSelectedStyles()[0] || 'Unknown'
                };
                
                library.unshift(track); // Add to beginning
                
                // Save to localStorage
                localStorage.setItem('musicLibrary', JSON.stringify(library));
                
                alert('Track added to your library!');
            } else {
                alert('No track to add to library');
            }
        }

        function createAnother() {
            resetForm();
        }

        function resetForm() {
            document.getElementById('generationSection').style.display = 'block';
            document.getElementById('generationProgress').classList.remove('active');
            document.getElementById('generationResult').classList.remove('active');
            document.getElementById('generationForm').reset();
            
            // Reset style pills
            document.querySelectorAll('.style-pill').forEach(pill => {
                pill.classList.remove('selected');
            });
        }

        // Mobile sidebar toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
    </script>

    <!-- Firebase Integration -->
    <script type="module">
        import { authManager } from '/js/firebase-config-safe.js';
        
        authManager.onAuthStateChange((user) => {
            if (user) {
                updateUserCredits(user);
            } else {
                // Redirect to auth if not logged in
                // window.location.href = '/auth?redirect=/create';
            }
        });

        function updateUserCredits(user) {
            const subscriptionCredits = {
                'free': 10,
                'starter': 500,
                'pro': 2000,
                'unlimited': 10000
            };
            
            const subscription = user.subscription || 'free';
            const credits = subscriptionCredits[subscription];
            document.getElementById('userCredits').textContent = credits;
        }
    </script>
</body>
</html>